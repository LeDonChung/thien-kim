<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Tồn kho - ERP</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="assets/css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-industry"></i>
                ERP
            </div>
            <div class="user-info">
                <span>Xin chào, Admin</span>
                <i class="fas fa-user-circle" style="font-size: 1.5rem;"></i>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar">
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="index.html" class="nav-link" data-page="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="sales-orders.html" class="nav-link" data-page="sales-orders">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Quản lý Đơn hàng</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="products.html" class="nav-link" data-page="products">
                    <i class="fas fa-box"></i>
                    <span>Quản lý Sản phẩm</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="bom.html" class="nav-link" data-page="bom">
                    <i class="fas fa-sitemap"></i>
                    <span>Quản lý BOM</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="inventory.html" class="nav-link active" data-page="inventory">
                    <i class="fas fa-warehouse"></i>
                    <span>Quản lý Tồn kho</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="materials.html" class="nav-link" data-page="materials">
                    <i class="fas fa-cubes"></i>
                    <span>Nguyên vật liệu</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="suppliers.html" class="nav-link" data-page="suppliers">
                    <i class="fas fa-truck"></i>
                    <span>Nhà cung cấp</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="procurement.html" class="nav-link" data-page="procurement">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Quản lý Mua hàng</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="purchase-orders.html" class="nav-link" data-page="purchase-orders">
                    <i class="fas fa-file-invoice"></i>
                    <span>Đơn đặt hàng (PO)</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="rfq.html" class="nav-link" data-page="rfq">
                    <i class="fas fa-question-circle"></i>
                    <span>Yêu cầu báo giá (RFQ)</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="reports.html" class="nav-link" data-page="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Báo cáo</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="settings.html" class="nav-link" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>Cài đặt</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-header">
            <h1 class="content-title">Quản lý Tồn kho</h1>
            <div class="breadcrumb">Trang chủ > Quản lý Tồn kho</div>
        </div>

        <!-- Search and Filters -->
        <div class="search-filters">
            <div class="search-row">
                <div class="search-input">
                    <i class="fas fa-search"></i>
                    <input type="text" class="form-input" placeholder="Tìm kiếm theo mã NVL, tên nguyên vật liệu...">
                </div>
                <select class="form-select" style="width: 200px;">
                    <option value="">Tất cả trạng thái</option>
                    <option value="normal">Bình thường</option>
                    <option value="low">Sắp hết</option>
                    <option value="critical">Cảnh báo</option>
                    <option value="out">Hết hàng</option>
                </select>
                <button class="btn btn-primary" onclick="showStockInModal()">
                    <i class="fas fa-plus"></i>
                    Nhập kho
                </button>
                <button class="btn btn-secondary" onclick="showStockOutModal()">
                    <i class="fas fa-minus"></i>
                    Xuất kho
                </button>
            </div>
        </div>

        <!-- Inventory Overview -->
        <div class="dashboard-grid" style="grid-template-columns: repeat(4, 1fr);">
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon inventory">
                        <i class="fas fa-cubes"></i>
                    </div>
                    <div>
                        <div class="card-title">Tổng NVL</div>
                        <div class="card-subtitle">Đang quản lý</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <div class="stat-number">342</div>
                    <div class="stat-label">loại NVL</div>
                </div>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon" style="background: #e8f5e8;">
                        <i class="fas fa-check-circle" style="color: #2e7d32;"></i>
                    </div>
                    <div>
                        <div class="card-title">Đủ hàng</div>
                        <div class="card-subtitle">Tồn kho tốt</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <div class="stat-number">295</div>
                    <div class="stat-label">loại NVL</div>
                </div>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon" style="background: #fff3e0;">
                        <i class="fas fa-exclamation-triangle" style="color: #ef6c00;"></i>
                    </div>
                    <div>
                        <div class="card-title">Sắp hết</div>
                        <div class="card-subtitle">Cần nhập thêm</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <div class="stat-number">32</div>
                    <div class="stat-label">loại NVL</div>
                </div>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon" style="background: #ffebee;">
                        <i class="fas fa-times-circle" style="color: #c62828;"></i>
                    </div>
                    <div>
                        <div class="card-title">Cảnh báo</div>
                        <div class="card-subtitle">Hết hàng/Thiếu</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <div class="stat-number">15</div>
                    <div class="stat-label">loại NVL</div>
                </div>
            </div>
        </div>

        <!-- Critical Items Alert -->
        <div class="content-card" style="background: #fff3cd; border: 1px solid #ffeaa7;">
            <h3 style="color: #856404; margin-bottom: 1rem;">
                <i class="fas fa-exclamation-triangle"></i>
                Cảnh báo tồn kho
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                <div style="background: white; padding: 1rem; border-radius: 5px; border-left: 4px solid #dc3545;">
                    <div style="font-weight: bold; color: #dc3545;">NVL-007 - Đệm ngòi</div>
                    <div>Tồn kho: <strong>5 cái</strong> | Mức tối thiểu: 20 cái</div>
                    <div style="margin-top: 0.5rem;">
                        <button class="btn btn-sm btn-danger" onclick="createPR('NVL-007')">Tạo PR</button>
                    </div>
                </div>
                <div style="background: white; padding: 1rem; border-radius: 5px; border-left: 4px solid #dc3545;">
                    <div style="font-weight: bold; color: #dc3545;">NVL-012 - Vít nhỏ</div>
                    <div>Tồn kho: <strong>0 cái</strong> | Mức tối thiểu: 100 cái</div>
                    <div style="margin-top: 0.5rem;">
                        <button class="btn btn-sm btn-danger" onclick="createPR('NVL-012')">Tạo PR</button>
                    </div>
                </div>
                <div style="background: white; padding: 1rem; border-radius: 5px; border-left: 4px solid #ffc107;">
                    <div style="font-weight: bold; color: #856404;">NVL-025 - Nhựa màu xanh</div>
                    <div>Tồn kho: <strong>25 kg</strong> | Mức tối thiểu: 50 kg</div>
                    <div style="margin-top: 0.5rem;">
                        <button class="btn btn-sm btn-warning" onclick="createPR('NVL-025')">Tạo PR</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Table -->
        <div class="content-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="color: #333;">Danh sách tồn kho</h3>
                <div class="action-buttons">
                    <button class="btn btn-secondary">
                        <i class="fas fa-download"></i>
                        Xuất Excel
                    </button>
                    <button class="btn btn-success">
                        <i class="fas fa-sync-alt"></i>
                        Cập nhật tồn kho
                    </button>
                </div>
            </div>

            <table class="data-table" id="inventoryTable">
                <thead>
                    <tr>
                        <th data-sort="material-code">Mã NVL</th>
                        <th data-sort="material-name">Tên nguyên vật liệu</th>
                        <th data-sort="unit">Đơn vị</th>
                        <th data-sort="on-hand">On-hand</th>
                        <th data-sort="reserved">Reserved</th>
                        <th data-sort="available">Available</th>
                        <th data-sort="min-stock">Mức tối thiểu</th>
                        <th data-sort="status">Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <!-- Inventory data will be loaded here dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Stock Movement Summary -->
        <div class="content-card">
            <h3 style="margin-bottom: 1rem; color: #333;">
                <i class="fas fa-exchange-alt" style="margin-right: 0.5rem; color: #667eea;"></i>
                Biến động tồn kho hôm nay
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div style="text-align: center; padding: 1rem; background: #e8f5e8; border-radius: 8px;">
                    <i class="fas fa-arrow-up" style="font-size: 2rem; color: #28a745; margin-bottom: 0.5rem;"></i>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">+1,250</div>
                    <div style="color: #666;">Nhập kho</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: #ffebee; border-radius: 8px;">
                    <i class="fas fa-arrow-down" style="font-size: 2rem; color: #dc3545; margin-bottom: 0.5rem;"></i>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #dc3545;">-890</div>
                    <div style="color: #666;">Xuất kho</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: #e3f2fd; border-radius: 8px;">
                    <i class="fas fa-sync-alt" style="font-size: 2rem; color: #1565c0; margin-bottom: 0.5rem;"></i>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #1565c0;">15</div>
                    <div style="color: #666;">Điều chỉnh</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: #fff3e0; border-radius: 8px;">
                    <i class="fas fa-lock" style="font-size: 2rem; color: #ef6c00; margin-bottom: 0.5rem;"></i>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #ef6c00;">245</div>
                    <div style="color: #666;">Giữ chỗ</div>
                </div>
            </div>
        </div>

        <!-- Stock In Modal -->
        <div id="stockInModal" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>Nhập kho</h3>
                    <button class="modal-close" onclick="closeStockModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="stockInForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nguyên vật liệu *</label>
                                <select id="stockInMaterial" class="form-select" required onchange="loadMaterialInfo('in')">
                                    <option value="">Chọn nguyên vật liệu</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Số lượng nhập *</label>
                                <input type="number" id="stockInQuantity" class="form-input" min="0.01" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Đơn vị</label>
                                <input type="text" id="stockInUnit" class="form-input" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Giá nhập (VNĐ/đơn vị)</label>
                                <input type="number" id="stockInPrice" class="form-input" min="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nhà cung cấp</label>
                                <input type="text" id="stockInSupplier" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Số PO/Invoice</label>
                                <input type="text" id="stockInReference" class="form-input" placeholder="PO-001, INV-123">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ghi chú</label>
                            <textarea id="stockInNotes" class="form-input" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeStockModal()">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="processStockIn()">Nhập kho</button>
                </div>
            </div>
        </div>

        <!-- Stock Out Modal -->
        <div id="stockOutModal" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>Xuất kho</h3>
                    <button class="modal-close" onclick="closeStockModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="stockOutForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nguyên vật liệu *</label>
                                <select id="stockOutMaterial" class="form-select" required onchange="loadMaterialInfo('out')">
                                    <option value="">Chọn nguyên vật liệu</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Số lượng xuất *</label>
                                <input type="number" id="stockOutQuantity" class="form-input" min="0.01" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Đơn vị</label>
                                <input type="text" id="stockOutUnit" class="form-input" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tồn kho hiện tại</label>
                                <input type="text" id="stockOutCurrent" class="form-input" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Lý do xuất *</label>
                                <select id="stockOutReason" class="form-select" required>
                                    <option value="">Chọn lý do</option>
                                    <option value="production">Sản xuất</option>
                                    <option value="sale">Bán hàng</option>
                                    <option value="adjustment">Điều chỉnh</option>
                                    <option value="damage">Hư hỏng</option>
                                    <option value="other">Khác</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Số tham chiếu</label>
                                <input type="text" id="stockOutReference" class="form-input" placeholder="WO-001, SO-123">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ghi chú</label>
                            <textarea id="stockOutNotes" class="form-input" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeStockModal()">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="processStockOut()">Xuất kho</button>
                </div>
            </div>
        </div>

        <!-- Stock Adjustment Modal -->
        <div id="stockAdjustModal" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>Điều chỉnh tồn kho</h3>
                    <button class="modal-close" onclick="closeStockModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="stockAdjustForm">
                        <div class="form-group">
                            <label class="form-label">Nguyên vật liệu</label>
                            <input type="text" id="adjustMaterialName" class="form-input" readonly>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Tồn kho hiện tại</label>
                                <input type="text" id="adjustCurrentStock" class="form-input" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tồn kho mới *</label>
                                <input type="number" id="adjustNewStock" class="form-input" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lý do điều chỉnh *</label>
                            <select id="adjustReason" class="form-select" required>
                                <option value="">Chọn lý do</option>
                                <option value="count">Kiểm kê</option>
                                <option value="damage">Hư hỏng</option>
                                <option value="lost">Thất thoát</option>
                                <option value="found">Tìm thấy</option>
                                <option value="other">Khác</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ghi chú</label>
                            <textarea id="adjustNotes" class="form-input" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeStockModal()">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="processStockAdjust()">Điều chỉnh</button>
                </div>
            </div>
        </div>

        <!-- Stock History Modal -->
        <div id="stockHistoryModal" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 id="historyModalTitle">Lịch sử biến động tồn kho</h3>
                    <button class="modal-close" onclick="closeStockModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <table class="data-table" id="stockHistoryTable">
                        <thead>
                            <tr>
                                <th>Ngày</th>
                                <th>Loại</th>
                                <th>Số lượng</th>
                                <th>Tồn kho sau</th>
                                <th>Lý do</th>
                                <th>Tham chiếu</th>
                                <th>Người thực hiện</th>
                            </tr>
                        </thead>
                        <tbody id="stockHistoryTableBody">
                            <!-- History data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeStockModal()">Đóng</button>
                </div>
            </div>
        </div>
    </main>

    <script src="assets/js/shared.js"></script>
    <script>
        // Inventory Management with localStorage
        class InventoryManager {
            constructor() {
                this.materialsStorageKey = 'tkMaterials_data';
                this.inventoryStorageKey = 'tkInventory_data';
                this.transactionsStorageKey = 'tkStockTransactions_data';
                this.currentMaterialId = null;
                
                this.loadData();
                this.initializeInventoryData();
                this.renderInventory();
                this.updateStatistics();
                this.updateCriticalItems();
                this.loadMaterialOptions();
                this.updateStockMovement();
            }

            loadData() {
                this.materials = JSON.parse(localStorage.getItem(this.materialsStorageKey)) || [];
                this.inventory = JSON.parse(localStorage.getItem(this.inventoryStorageKey)) || [];
                this.transactions = JSON.parse(localStorage.getItem(this.transactionsStorageKey)) || [];
            }

            initializeInventoryData() {
                // Sync inventory with materials data
                this.materials.forEach(material => {
                    let inventoryItem = this.inventory.find(inv => inv.materialId === material.id);
                    if (!inventoryItem) {
                        inventoryItem = {
                            materialId: material.id,
                            materialCode: material.code,
                            materialName: material.name,
                            unit: material.unit,
                            onHand: material.stock || 0,
                            reserved: 0,
                            minStock: material.minStock || 0,
                            lastUpdated: new Date().toISOString()
                        };
                        this.inventory.push(inventoryItem);
                    } else {
                        // Update material info if changed
                        inventoryItem.materialName = material.name;
                        inventoryItem.unit = material.unit;
                        inventoryItem.minStock = material.minStock || 0;
                        inventoryItem.onHand = material.stock || 0;
                    }
                });
                this.saveInventory();
            }

            saveInventory() {
                localStorage.setItem(this.inventoryStorageKey, JSON.stringify(this.inventory));
                // Also update materials stock
                this.inventory.forEach(inv => {
                    const material = this.materials.find(m => m.id === inv.materialId);
                    if (material) {
                        material.stock = inv.onHand;
                    }
                });
                localStorage.setItem(this.materialsStorageKey, JSON.stringify(this.materials));
            }

            saveTransactions() {
                localStorage.setItem(this.transactionsStorageKey, JSON.stringify(this.transactions));
            }

            getStockStatus(inventoryItem) {
                const available = inventoryItem.onHand - inventoryItem.reserved;
                if (inventoryItem.onHand <= 0) return 'out-of-stock';
                if (available <= inventoryItem.minStock) return 'critical';
                if (available <= inventoryItem.minStock * 1.5) return 'low';
                return 'normal';
            }

            renderInventory() {
                const tbody = document.getElementById('inventoryTableBody');
                tbody.innerHTML = '';

                this.inventory.forEach(inv => {
                    const available = inv.onHand - inv.reserved;
                    const status = this.getStockStatus(inv);
                    const statusText = {
                        'normal': 'Đủ hàng',
                        'low': 'Sắp hết',
                        'critical': 'Cảnh báo',
                        'out-of-stock': 'Hết hàng'
                    };
                    const statusClass = {
                        'normal': 'status-completed',
                        'low': 'status-processing',
                        'critical': 'status-cancelled',
                        'out-of-stock': 'status-cancelled'
                    };

                    const getColorStyle = (value, status) => {
                        if (status === 'out-of-stock') return 'color: #dc3545; font-weight: bold;';
                        if (status === 'critical') return 'color: #dc3545; font-weight: bold;';
                        if (status === 'low') return 'color: #ffc107; font-weight: bold;';
                        return 'color: #28a745; font-weight: bold;';
                    };

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td data-material-code="${inv.materialCode}"><strong>${inv.materialCode}</strong></td>
                        <td data-material-name="${inv.materialName}">${inv.materialName}</td>
                        <td data-unit="${inv.unit}">${inv.unit}</td>
                        <td data-on-hand="${inv.onHand}" style="${status !== 'normal' ? 'color: #dc3545; font-weight: bold;' : ''}">${inv.onHand}</td>
                        <td data-reserved="${inv.reserved}">${inv.reserved}</td>
                        <td data-available="${available}" style="${getColorStyle(available, status)}">${available}</td>
                        <td data-min-stock="${inv.minStock}">${inv.minStock}</td>
                        <td data-status="${status}">
                            <span class="status-badge ${statusClass[status]}">
                                ${statusText[status]}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-primary" onclick="adjustStock('${inv.materialId}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${status !== 'normal' ? `
                                    <button class="btn btn-sm btn-danger" onclick="createPR('${inv.materialId}')">
                                        <i class="fas fa-shopping-cart"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-info" onclick="viewHistory('${inv.materialId}')">
                                    <i class="fas fa-history"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            updateStatistics() {
                const total = this.inventory.length;
                const normal = this.inventory.filter(inv => this.getStockStatus(inv) === 'normal').length;
                const low = this.inventory.filter(inv => this.getStockStatus(inv) === 'low').length;
                const critical = this.inventory.filter(inv => ['critical', 'out-of-stock'].includes(this.getStockStatus(inv))).length;

                const cards = document.querySelectorAll('.dashboard-card .stat-number');
                if (cards[0]) cards[0].textContent = total;
                if (cards[1]) cards[1].textContent = normal;
                if (cards[2]) cards[2].textContent = low;
                if (cards[3]) cards[3].textContent = critical;
            }

            updateCriticalItems() {
                const criticalItems = this.inventory.filter(inv => 
                    ['critical', 'out-of-stock'].includes(this.getStockStatus(inv))
                ).slice(0, 3);

                const container = document.querySelector('[style*="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr))"]');
                if (container) {
                    container.innerHTML = '';
                    
                    if (criticalItems.length === 0) {
                        container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #28a745;"><i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i><br>Không có mặt hàng nào cần cảnh báo</div>';
                        return;
                    }

                    criticalItems.forEach(inv => {
                        const available = inv.onHand - inv.reserved;
                        const status = this.getStockStatus(inv);
                        const borderColor = status === 'out-of-stock' ? '#dc3545' : '#ffc107';
                        const textColor = status === 'out-of-stock' ? '#dc3545' : '#856404';
                        
                        const itemDiv = document.createElement('div');
                        itemDiv.style.cssText = `background: white; padding: 1rem; border-radius: 5px; border-left: 4px solid ${borderColor};`;
                        itemDiv.innerHTML = `
                            <div style="font-weight: bold; color: ${textColor};">${inv.materialCode} - ${inv.materialName}</div>
                            <div>Tồn kho: <strong>${inv.onHand} ${inv.unit}</strong> | Mức tối thiểu: ${inv.minStock} ${inv.unit}</div>
                            <div style="margin-top: 0.5rem;">
                                <button class="btn btn-sm btn-danger" onclick="createPR('${inv.materialId}')">Tạo PR</button>
                            </div>
                        `;
                        container.appendChild(itemDiv);
                    });
                }
            }

            updateStockMovement() {
                const today = new Date().toDateString();
                const todayTransactions = this.transactions.filter(t => 
                    new Date(t.timestamp).toDateString() === today
                );

                const stockIn = todayTransactions
                    .filter(t => t.type === 'in')
                    .reduce((sum, t) => sum + t.quantity, 0);
                
                const stockOut = todayTransactions
                    .filter(t => t.type === 'out')
                    .reduce((sum, t) => sum + t.quantity, 0);
                
                const adjustments = todayTransactions.filter(t => t.type === 'adjust').length;
                const reserved = this.inventory.reduce((sum, inv) => sum + inv.reserved, 0);

                const movementCards = document.querySelectorAll('[style*="text-align: center; padding: 1rem"]');
                if (movementCards[0]) {
                    movementCards[0].querySelector('div[style*="font-size: 1.5rem"]').textContent = `+${stockIn}`;
                }
                if (movementCards[1]) {
                    movementCards[1].querySelector('div[style*="font-size: 1.5rem"]').textContent = `-${stockOut}`;
                }
                if (movementCards[2]) {
                    movementCards[2].querySelector('div[style*="font-size: 1.5rem"]').textContent = adjustments;
                }
                if (movementCards[3]) {
                    movementCards[3].querySelector('div[style*="font-size: 1.5rem"]').textContent = reserved;
                }
            }

            loadMaterialOptions() {
                const selects = ['stockInMaterial', 'stockOutMaterial'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Chọn nguyên vật liệu</option>';
                        this.materials.forEach(material => {
                            const option = document.createElement('option');
                            option.value = material.id;
                            option.textContent = `${material.code} - ${material.name}`;
                            select.appendChild(option);
                        });
                    }
                });
            }

            processStockTransaction(type, data) {
                const transaction = {
                    id: `TXN-${Date.now()}`,
                    type: type, // 'in', 'out', 'adjust'
                    materialId: data.materialId,
                    materialCode: data.materialCode,
                    quantity: data.quantity,
                    reason: data.reason || '',
                    reference: data.reference || '',
                    notes: data.notes || '',
                    price: data.price || 0,
                    supplier: data.supplier || '',
                    user: 'Admin',
                    timestamp: new Date().toISOString()
                };

                // Update inventory
                const inventoryItem = this.inventory.find(inv => inv.materialId === data.materialId);
                if (inventoryItem) {
                    const oldStock = inventoryItem.onHand;
                    
                    if (type === 'in') {
                        inventoryItem.onHand += data.quantity;
                    } else if (type === 'out') {
                        inventoryItem.onHand = Math.max(0, inventoryItem.onHand - data.quantity);
                    } else if (type === 'adjust') {
                        inventoryItem.onHand = data.newStock;
                        transaction.quantity = data.newStock - oldStock; // Store the difference
                    }
                    
                    transaction.stockAfter = inventoryItem.onHand;
                    inventoryItem.lastUpdated = new Date().toISOString();
                }

                this.transactions.push(transaction);
                this.saveInventory();
                this.saveTransactions();
                
                return transaction;
            }
        }

        // Initialize Inventory Manager
        const inventoryManager = new InventoryManager();

        // Modal functions
        function showStockInModal() {
            document.getElementById('stockInForm').reset();
            document.getElementById('stockInModal').style.display = 'flex';
        }

        function showStockOutModal() {
            document.getElementById('stockOutForm').reset();
            document.getElementById('stockOutModal').style.display = 'flex';
        }

        function closeStockModal() {
            const modals = ['stockInModal', 'stockOutModal', 'stockAdjustModal', 'stockHistoryModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) modal.style.display = 'none';
            });
            inventoryManager.currentMaterialId = null;
        }

        function loadMaterialInfo(type) {
            const materialId = document.getElementById(`stock${type.charAt(0).toUpperCase() + type.slice(1)}Material`).value;
            const material = inventoryManager.materials.find(m => m.id === materialId);
            const inventory = inventoryManager.inventory.find(inv => inv.materialId === materialId);
            
            if (material && inventory) {
                document.getElementById(`stock${type.charAt(0).toUpperCase() + type.slice(1)}Unit`).value = material.unit;
                
                if (type === 'in') {
                    document.getElementById('stockInPrice').value = material.price || 0;
                    document.getElementById('stockInSupplier').value = material.supplierName || '';
                } else if (type === 'out') {
                    document.getElementById('stockOutCurrent').value = `${inventory.onHand} ${material.unit}`;
                }
            }
        }

        function processStockIn() {
            const form = document.getElementById('stockInForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const materialId = document.getElementById('stockInMaterial').value;
            const material = inventoryManager.materials.find(m => m.id === materialId);
            const quantity = parseFloat(document.getElementById('stockInQuantity').value);
            
            const data = {
                materialId: materialId,
                materialCode: material.code,
                quantity: quantity,
                price: parseFloat(document.getElementById('stockInPrice').value) || 0,
                supplier: document.getElementById('stockInSupplier').value,
                reference: document.getElementById('stockInReference').value,
                notes: document.getElementById('stockInNotes').value,
                reason: 'Nhập kho'
            };

            try {
                inventoryManager.processStockTransaction('in', data);
                inventoryManager.renderInventory();
                inventoryManager.updateStatistics();
                inventoryManager.updateCriticalItems();
                inventoryManager.updateStockMovement();
                
                window.notifications.success(`Đã nhập ${quantity} ${material.unit} ${material.name}`);
                closeStockModal();
            } catch (error) {
                window.notifications.error('Có lỗi xảy ra khi nhập kho');
                console.error('Stock in error:', error);
            }
        }

        function processStockOut() {
            const form = document.getElementById('stockOutForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const materialId = document.getElementById('stockOutMaterial').value;
            const material = inventoryManager.materials.find(m => m.id === materialId);
            const inventory = inventoryManager.inventory.find(inv => inv.materialId === materialId);
            const quantity = parseFloat(document.getElementById('stockOutQuantity').value);
            
            if (quantity > inventory.onHand) {
                window.notifications.error(`Không đủ tồn kho. Chỉ còn ${inventory.onHand} ${material.unit}`);
                return;
            }

            const reasonSelect = document.getElementById('stockOutReason');
            const reasonText = reasonSelect.options[reasonSelect.selectedIndex].text;

            const data = {
                materialId: materialId,
                materialCode: material.code,
                quantity: quantity,
                reason: reasonText,
                reference: document.getElementById('stockOutReference').value,
                notes: document.getElementById('stockOutNotes').value
            };

            try {
                inventoryManager.processStockTransaction('out', data);
                inventoryManager.renderInventory();
                inventoryManager.updateStatistics();
                inventoryManager.updateCriticalItems();
                inventoryManager.updateStockMovement();
                
                window.notifications.success(`Đã xuất ${quantity} ${material.unit} ${material.name}`);
                closeStockModal();
            } catch (error) {
                window.notifications.error('Có lỗi xảy ra khi xuất kho');
                console.error('Stock out error:', error);
            }
        }

        function processStockAdjust() {
            const form = document.getElementById('stockAdjustForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const newStock = parseFloat(document.getElementById('adjustNewStock').value);
            const reasonSelect = document.getElementById('adjustReason');
            const reasonText = reasonSelect.options[reasonSelect.selectedIndex].text;

            const material = inventoryManager.materials.find(m => m.id === inventoryManager.currentMaterialId);
            const data = {
                materialId: inventoryManager.currentMaterialId,
                materialCode: material.code,
                newStock: newStock,
                reason: reasonText,
                notes: document.getElementById('adjustNotes').value
            };

            try {
                inventoryManager.processStockTransaction('adjust', data);
                inventoryManager.renderInventory();
                inventoryManager.updateStatistics();
                inventoryManager.updateCriticalItems();
                inventoryManager.updateStockMovement();
                
                window.notifications.success(`Đã điều chỉnh tồn kho ${material.name} thành ${newStock} ${material.unit}`);
                closeStockModal();
            } catch (error) {
                window.notifications.error('Có lỗi xảy ra khi điều chỉnh tồn kho');
                console.error('Stock adjust error:', error);
            }
        }

        // Main functions
        function adjustStock(materialId) {
            const material = inventoryManager.materials.find(m => m.id === materialId);
            const inventory = inventoryManager.inventory.find(inv => inv.materialId === materialId);
            
            if (material && inventory) {
                inventoryManager.currentMaterialId = materialId;
                document.getElementById('adjustMaterialName').value = `${material.code} - ${material.name}`;
                document.getElementById('adjustCurrentStock').value = `${inventory.onHand} ${material.unit}`;
                document.getElementById('adjustNewStock').value = inventory.onHand;
                document.getElementById('stockAdjustForm').reset();
                document.getElementById('adjustNewStock').value = inventory.onHand;
                document.getElementById('stockAdjustModal').style.display = 'flex';
            }
        }
        
        function createPR(materialId) {
            const material = inventoryManager.materials.find(m => m.id === materialId);
            if (material) {
                window.notifications.info(`Tạo yêu cầu mua hàng cho ${material.name}`);
                window.location.href = `procurement.html?material=${materialId}`;
            }
        }
        
        function viewHistory(materialId) {
            const material = inventoryManager.materials.find(m => m.id === materialId);
            const transactions = inventoryManager.transactions
                .filter(t => t.materialId === materialId)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (material) {
                document.getElementById('historyModalTitle').textContent = `Lịch sử biến động tồn kho - ${material.name}`;
                
                const tbody = document.getElementById('stockHistoryTableBody');
                tbody.innerHTML = '';

                if (transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">Chưa có giao dịch nào</td></tr>';
                } else {
                    transactions.forEach(txn => {
                        const typeText = {
                            'in': 'Nhập kho',
                            'out': 'Xuất kho',
                            'adjust': 'Điều chỉnh'
                        };
                        const typeColor = {
                            'in': '#28a745',
                            'out': '#dc3545',
                            'adjust': '#ffc107'
                        };

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(txn.timestamp).toLocaleString('vi-VN')}</td>
                            <td style="color: ${typeColor[txn.type]}; font-weight: bold;">${typeText[txn.type]}</td>
                            <td style="color: ${txn.type === 'out' ? '#dc3545' : '#28a745'};">${txn.type === 'out' ? '-' : '+'}${Math.abs(txn.quantity)} ${material.unit}</td>
                            <td>${txn.stockAfter || 'N/A'} ${material.unit}</td>
                            <td>${txn.reason}</td>
                            <td>${txn.reference || 'N/A'}</td>
                            <td>${txn.user}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                document.getElementById('stockHistoryModal').style.display = 'flex';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = ['stockInModal', 'stockOutModal', 'stockAdjustModal', 'stockHistoryModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeStockModal();
                }
            });
        }

        // Custom styles
        const customStyles = `
            .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; margin: 0 0.1rem; }
            .btn-group { display: flex; gap: 0.2rem; }
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }
            .modal-content {
                background: white;
                border-radius: 8px;
                width: 90%;
                max-height: 90%;
                overflow-y: auto;
            }
            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem 1.5rem;
                border-bottom: 1px solid #dee2e6;
            }
            .modal-header h3 {
                margin: 0;
                color: #333;
            }
            .modal-close {
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #666;
            }
            .modal-body {
                padding: 1.5rem;
            }
            .modal-footer {
                display: flex;
                justify-content: flex-end;
                gap: 0.5rem;
                padding: 1rem 1.5rem;
                border-top: 1px solid #dee2e6;
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = customStyles;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
