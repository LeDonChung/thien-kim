<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý BOM - ERP</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="assets/css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-industry"></i>
                ERP
            </div>
            <div class="user-info">
                <span>Xin chào, Admin</span>
                <i class="fas fa-user-circle" style="font-size: 1.5rem;"></i>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar">
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="index.html" class="nav-link" data-page="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="sales-orders.html" class="nav-link" data-page="sales-orders">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Quản lý Đơn hàng</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="products.html" class="nav-link" data-page="products">
                    <i class="fas fa-box"></i>
                    <span>Quản lý Sản phẩm</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="bom.html" class="nav-link active" data-page="bom">
                    <i class="fas fa-sitemap"></i>
                    <span>Quản lý BOM</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="inventory.html" class="nav-link" data-page="inventory">
                    <i class="fas fa-warehouse"></i>
                    <span>Quản lý Tồn kho</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="materials.html" class="nav-link" data-page="materials">
                    <i class="fas fa-cubes"></i>
                    <span>Nguyên vật liệu</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="suppliers.html" class="nav-link" data-page="suppliers">
                    <i class="fas fa-truck"></i>
                    <span>Nhà cung cấp</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="procurement.html" class="nav-link" data-page="procurement">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Quản lý Mua hàng</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="purchase-orders.html" class="nav-link" data-page="purchase-orders">
                    <i class="fas fa-file-invoice"></i>
                    <span>Đơn đặt hàng (PO)</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="rfq.html" class="nav-link" data-page="rfq">
                    <i class="fas fa-question-circle"></i>
                    <span>Yêu cầu báo giá (RFQ)</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="reports.html" class="nav-link" data-page="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Báo cáo</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="settings.html" class="nav-link" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>Cài đặt</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-header">
            <h1 class="content-title">Quản lý BOM (Bill of Materials)</h1>
            <div class="breadcrumb">Trang chủ > Quản lý BOM</div>
        </div>

        <!-- BOM Selection -->
        <div class="content-card">
            <div class="filters-row">
                <div class="search-group">
                    <select class="form-select" id="productSelect" style="min-width: 350px;">
                        <option value="">Chọn sản phẩm để xem BOM</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showCreateBOMModal()">
                        <i class="fas fa-plus"></i>
                        Tạo BOM mới
                    </button>
                    <button class="btn btn-secondary" onclick="importBOM()">
                        <i class="fas fa-upload"></i>
                        Nhập từ Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Create BOM Modal -->
        <div id="bomModal" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 id="bomModalTitle">Tạo BOM mới</h3>
                    <button class="modal-close" onclick="closeBOMModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="bomForm">
                        <div class="form-group">
                            <label class="form-label">Sản phẩm *</label>
                            <select id="bomProductSelect" class="form-select" required onchange="loadProductInfo()">
                                <option value="">Chọn sản phẩm</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mô tả BOM</label>
                            <textarea id="bomDescription" class="form-input" rows="2"></textarea>
                        </div>
                        
                        <h4 style="margin: 1.5rem 0 1rem 0; display: flex; justify-content: space-between; align-items: center;">
                            Danh sách nguyên vật liệu
                            <button type="button" class="btn btn-sm btn-success" onclick="addMaterialRow()">
                                <i class="fas fa-plus"></i> Thêm NVL
                            </button>
                        </h4>
                        
                        <div class="materials-container">
                            <table class="data-table" id="materialsTable">
                                <thead>
                                    <tr>
                                        <th>Mã NVL *</th>
                                        <th>Tên NVL *</th>
                                        <th>Đơn vị</th>
                                        <th>Số lượng *</th>
                                        <th>Ghi chú</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="materialsTableBody">
                                    <!-- Materials will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeBOMModal()">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveBOM()">Lưu BOM</button>
                </div>
            </div>
        </div>

        <!-- BOM Structure Display -->
        <div class="content-card" id="bomStructureCard" style="display: none;">
            <div class="card-header">
                <h3 class="card-title" id="bomStructureTitle">
                    <i class="fas fa-sitemap"></i>
                    Cấu trúc BOM
                </h3>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="exportBOM()">
                        <i class="fas fa-download"></i>
                        Xuất BOM
                    </button>
                    <button class="btn btn-warning" onclick="editCurrentBOM()">
                        <i class="fas fa-edit"></i>
                        Chỉnh sửa
                    </button>
                </div>
            </div>

            <!-- BOM Tree Structure -->
            <div class="bom-tree" id="bomTreeDisplay">
                <!-- BOM tree will be rendered here -->
            </div>
        </div>

        <!-- BOM Details Table -->
        <div class="content-card" id="bomDetailsCard" style="display: none;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-list-ul"></i>
                    Chi tiết BOM
                </h3>
            </div>
            <div class="table-container">
                <table class="data-table" id="bomDetailsTable">
                    <thead>
                        <tr>
                            <th>Mã NVL</th>
                            <th>Tên nguyên vật liệu</th>
                            <th>Đơn vị</th>
                            <th>Số lượng cần</th>
                            <th>Tồn kho</th>
                            <th>Khả dụng</th>
                            <th>Có thể sản xuất</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="bomDetailsTableBody">
                        <!-- BOM details will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="assets/js/shared.js"></script>
    <script>
        // BOM Management with localStorage
        class BOMManager {
            constructor() {
                this.bomStorageKey = 'tkBOM_data';
                this.materialsStorageKey = 'tkMaterials_data';
                this.productsStorageKey = 'tkProduct_data';
                this.currentEditBOM = null;
                this.currentSelectedProduct = null;
                
                this.loadData();
                this.initializeDefaultData();
                this.renderProductOptions();
                this.updateStatistics();
                this.handleURLParams();
            }

            loadData() {
                this.boms = JSON.parse(localStorage.getItem(this.bomStorageKey)) || [];
                this.materials = JSON.parse(localStorage.getItem(this.materialsStorageKey)) || [];
                this.products = JSON.parse(localStorage.getItem(this.productsStorageKey)) || [];
                
                // Load from other modules if available with new structure
                if (this.materials.length === 0) {
                    // Try both old and new storage keys
                    const materialsData = JSON.parse(localStorage.getItem('materialsData')) || 
                                         JSON.parse(localStorage.getItem('tkMaterials_data')) || [];
                    if (materialsData.length > 0) {
                        this.materials = materialsData.map(m => ({
                            id: m.code || m.id,
                            code: m.code || m.id,
                            name: m.name,
                            unit: m.unit || 'Cái',
                            // Support both old and new structure
                            onHand: m.onHand || m.stock || 0,
                            reserved: m.reserved || 0,
                            available: m.available || (m.onHand || m.stock || 0) - (m.reserved || 0),
                            minStock: m.minStock || 10,
                            price: m.price || 0,
                            // Backward compatibility
                            stock: m.onHand || m.stock || 0
                        }));
                        localStorage.setItem(this.materialsStorageKey, JSON.stringify(this.materials));
                    }
                }
                
                if (this.products.length === 0) {
                    // Try both old and new storage keys
                    const productsData = JSON.parse(localStorage.getItem('productsData')) || 
                                        JSON.parse(localStorage.getItem('tkProducts_data')) || [];
                    if (productsData.length > 0) {
                        this.products = productsData.map(p => ({
                            id: p.code || p.id,
                            code: p.code || p.id,
                            name: p.name,
                            category: p.category || 'Khác',
                            hasBOM: false
                        }));
                        localStorage.setItem(this.productsStorageKey, JSON.stringify(this.products));
                    }
                }
            }

            initializeDefaultData() {
                if (this.materials.length === 0) {
                    const defaultMaterials = [
                        { id: 'NVL-001', code: 'NVL-001', name: 'Thân bút', unit: 'Cái', stock: 250, minStock: 50, price: 3000 },
                        { id: 'NVL-002', code: 'NVL-002', name: 'Ruột bút', unit: 'Cái', stock: 180, minStock: 30, price: 2000 },
                        { id: 'NVL-003', code: 'NVL-003', name: 'Ngòi bi', unit: 'Cái', stock: 95, minStock: 20, price: 1500 },
                        { id: 'NVL-004', code: 'NVL-004', name: 'Nút bấm', unit: 'Cái', stock: 120, minStock: 25, price: 1000 },
                        { id: 'NVL-005', code: 'NVL-005', name: 'Lò xo', unit: 'Cái', stock: 200, minStock: 40, price: 800 },
                        { id: 'NVL-006', code: 'NVL-006', name: 'Kẹp cài', unit: 'Cái', stock: 85, minStock: 15, price: 500 },
                        { id: 'NVL-007', code: 'NVL-007', name: 'Đệm ngòi', unit: 'Cái', stock: 15, minStock: 30, price: 300 }
                    ];
                    localStorage.setItem(this.materialsStorageKey, JSON.stringify(defaultMaterials));
                    this.materials = defaultMaterials;
                }

                if (this.boms.length === 0) {
                    const defaultBOMs = [
                        {
                            id: 'BOM-SP-001',
                            productId: 'SP-001',
                            productName: 'Bút bi bấm',
                            description: 'BOM cho bút bi bấm cao cấp',
                            materials: [
                                { materialId: 'NVL-001', materialName: 'Thân bút', unit: 'Cái', quantity: 1, notes: '' },
                                { materialId: 'NVL-002', materialName: 'Ruột bút', unit: 'Cái', quantity: 1, notes: '' },
                                { materialId: 'NVL-003', materialName: 'Ngòi bi', unit: 'Cái', quantity: 1, notes: '' },
                                { materialId: 'NVL-004', materialName: 'Nút bấm', unit: 'Cái', quantity: 1, notes: '' },
                                { materialId: 'NVL-005', materialName: 'Lò xo', unit: 'Cái', quantity: 1, notes: '' },
                                { materialId: 'NVL-006', materialName: 'Kẹp cài', unit: 'Cái', quantity: 1, notes: '' },
                                { materialId: 'NVL-007', materialName: 'Đệm ngòi', unit: 'Cái', quantity: 1, notes: 'Cần kiểm tra chất lượng' }
                            ],
                            createdAt: new Date().toISOString()
                        }
                    ];
                    localStorage.setItem(this.bomStorageKey, JSON.stringify(defaultBOMs));
                    this.boms = defaultBOMs;
                }
            }

            saveBOMData() {
                localStorage.setItem(this.bomStorageKey, JSON.stringify(this.boms));
            }

            renderProductOptions() {
                const select = document.getElementById('productSelect');
                const bomProductSelect = document.getElementById('bomProductSelect');
                
                [select, bomProductSelect].forEach(element => {
                    if (element) {
                        element.innerHTML = element === select ? 
                            '<option value="">Chọn sản phẩm để xem BOM</option>' : 
                            '<option value="">Chọn sản phẩm</option>';
                        
                        this.products.forEach(product => {
                            const hasBOM = this.boms.some(bom => bom.productId === product.id || bom.productId === product.code);
                            const option = document.createElement('option');
                            option.value = product.id || product.code;
                            option.textContent = `${product.code || product.id} - ${product.name}${hasBOM ? ' (Có BOM)' : ''}`;
                            element.appendChild(option);
                        });
                    }
                });
                
                // Update product hasBOM status
                this.products.forEach(product => {
                    const hasBOM = this.boms.some(bom => bom.productId === product.id || bom.productId === product.code);
                    product.hasBOM = hasBOM;
                });
                localStorage.setItem(this.productsStorageKey, JSON.stringify(this.products));
            }

            updateStatistics() {
                const totalBOMs = this.boms.length;
                const totalProducts = this.products.length;
                const productsWithBOM = this.products.filter(p => p.hasBOM).length;
                const totalMaterials = [...new Set(this.boms.flatMap(bom => bom.materials.map(m => m.materialId)))].length;

                const cards = document.querySelectorAll('.dashboard-card .stat-number');
                if (cards[0]) cards[0].textContent = totalBOMs;
                if (cards[1]) cards[1].textContent = productsWithBOM;
                if (cards[2]) cards[2].textContent = totalProducts - productsWithBOM;
                if (cards[3]) cards[3].textContent = totalMaterials;
            }

            handleURLParams() {
                const params = new URLSearchParams(window.location.search);
                const productId = params.get('product') || params.get('create');
                
                if (productId) {
                    const select = document.getElementById('productSelect');
                    if (select) {
                        select.value = productId;
                        this.loadBOMForProduct(productId);
                    }
                    
                    if (params.get('create')) {
                        setTimeout(() => showCreateBOMModal(), 500);
                    }
                }
            }

            loadBOMForProduct(productId) {
                this.currentSelectedProduct = productId;
                
                // Refresh materials data to get latest stock info
                this.refreshMaterialsData();
                
                const bom = this.boms.find(b => b.productId === productId);
                const product = this.products.find(p => p.id === productId);
                
                if (bom && product) {
                    this.renderBOMStructure(bom, product);
                    this.renderBOMDetails(bom);
                    document.getElementById('bomStructureCard').style.display = 'block';
                    document.getElementById('bomDetailsCard').style.display = 'block';
                    document.getElementById('productionCalculationCard').style.display = 'block';
                } else {
                    document.getElementById('bomStructureCard').style.display = 'none';
                    document.getElementById('bomDetailsCard').style.display = 'none';
                    document.getElementById('productionCalculationCard').style.display = 'none';
                    if (productId) {
                        window.notifications.info(`Sản phẩm ${productId} chưa có BOM. Hãy tạo BOM mới.`);
                    }
                }
            }

            // Refresh materials data from latest localStorage
            refreshMaterialsData() {
                const latestMaterials = JSON.parse(localStorage.getItem('tkMaterials_data')) || [];
                if (latestMaterials.length > 0) {
                    // Update existing materials with latest data
                    this.materials = latestMaterials.map(m => ({
                        id: m.code || m.id,
                        code: m.code || m.id,
                        name: m.name,
                        unit: m.unit || 'Cái',
                        onHand: m.onHand || m.stock || 0,
                        reserved: m.reserved || 0,
                        available: m.available || (m.onHand || m.stock || 0) - (m.reserved || 0),
                        minStock: m.minStock || 10,
                        price: m.price || 0,
                        stock: m.onHand || m.stock || 0
                    }));
                }
            }

            renderBOMStructure(bom, product) {
                const title = document.getElementById('bomStructureTitle');
                const treeDisplay = document.getElementById('bomTreeDisplay');
                
                title.textContent = `Cấu trúc BOM - ${product.name} (${product.code})`;
                
                let treeHTML = `
                    <div class="tree-item" style="margin-bottom: 0.5rem;">
                        <i class="fas fa-box text-primary"></i>
                        <strong>${product.code} - ${product.name} (1)</strong>
                        <span class="badge" style="background: #28a745; color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem; margin-left: 0.5rem;">
                            BOM
                        </span>
                    </div>
                    <div style="margin-left: 2rem;">
                `;

                bom.materials.forEach(material => {
                    const materialData = this.materials.find(m => m.id === material.materialId || m.code === material.materialId);
                    // Sử dụng cấu trúc dữ liệu từ Materials module
                    const stock = materialData ? (materialData.onHand || materialData.stock || 0) : 0;
                    const available = materialData ? (materialData.available || (materialData.onHand - (materialData.reserved || 0)) || materialData.stock || 0) : 0;
                    const minStock = materialData ? (materialData.minStock || 0) : 0;
                    const isLowStock = available <= minStock && minStock > 0;
                    
                    treeHTML += `
                        <div class="tree-item" style="margin-bottom: 0.3rem;">
                            <i class="fas fa-minus" style="color: #666;"></i>
                            <i class="fas fa-cube text-info"></i>
                            <span>${material.materialId} - ${material.materialName} (${material.quantity})</span>
                            <span style="color: ${isLowStock ? '#ff6b6b' : '#666'}; font-size: 0.9rem; margin-left: 1rem;">
                                Tồn kho: ${stock} | Khả dụng: ${available}${isLowStock ? ' - Cảnh báo!' : ''}
                            </span>
                        </div>
                    `;
                });

                treeHTML += '</div>';
                treeDisplay.innerHTML = treeHTML;
            }

            renderBOMDetails(bom) {
                const tbody = document.getElementById('bomDetailsTableBody');
                tbody.innerHTML = '';

                bom.materials.forEach(material => {
                    const materialData = this.materials.find(m => m.id === material.materialId || m.code === material.materialId);
                    
                    // Sử dụng cấu trúc dữ liệu từ Materials module
                    const onHand = materialData ? (materialData.onHand || materialData.stock || 0) : 0;
                    const reserved = materialData ? (materialData.reserved || 0) : 0;
                    const available = materialData ? (materialData.available || (onHand - reserved) || materialData.stock || 0) : 0;
                    const minStock = materialData ? (materialData.minStock || 0) : 0;
                    
                    const canProduce = Math.floor(available / material.quantity);
                    const isLowStock = available <= minStock && minStock > 0;
                    const isShortage = available < material.quantity;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${material.materialId}</strong></td>
                        <td>${material.materialName}</td>
                        <td>${material.unit}</td>
                        <td>${material.quantity}</td>
                        <td style="color: ${isLowStock ? '#ff6b6b' : 'inherit'}; font-weight: ${isLowStock ? 'bold' : 'normal'};">
                            On-Hand: ${onHand}<br>
                            <small style="color: #666;">Reserved: ${reserved}</small>
                        </td>
                        <td style="color: ${isShortage ? '#ff6b6b' : isLowStock ? '#ff6b6b' : 'inherit'}; font-weight: ${isShortage || isLowStock ? 'bold' : 'normal'};">
                            ${available}
                        </td>
                        <td style="color: ${canProduce === 0 ? '#ff6b6b' : 'inherit'}; font-weight: ${canProduce === 0 ? 'bold' : 'normal'};">
                            ${canProduce}
                        </td>
                        <td>
                            <span class="status-badge ${isShortage ? 'status-pending' : isLowStock ? 'status-processing' : 'status-completed'}">
                                ${isShortage ? 'Thiếu NVL' : isLowStock ? 'Sắp hết' : 'Đủ'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-primary" onclick="viewMaterial('${material.materialId}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${isLowStock ? `
                                    <button class="btn btn-sm btn-warning" onclick="createPR('${material.materialId}')">
                                        <i class="fas fa-shopping-cart"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            addBOM(bomData) {
                const newBOM = {
                    ...bomData,
                    id: `BOM-${bomData.productId}`,
                    createdAt: new Date().toISOString()
                };
                
                // Remove existing BOM for the same product if any
                this.boms = this.boms.filter(bom => bom.productId !== bomData.productId);
                this.boms.push(newBOM);
                this.saveBOMData();
                
                // Update product to mark it has BOM in all storage locations
                const productIndex = this.products.findIndex(p => (p.id === bomData.productId || p.code === bomData.productId));
                if (productIndex !== -1) {
                    this.products[productIndex].hasBOM = true;
                    localStorage.setItem(this.productsStorageKey, JSON.stringify(this.products));
                }
                
                // Also update in main products storage if different
                const mainProducts = JSON.parse(localStorage.getItem('productsData')) || [];
                const mainProductIndex = mainProducts.findIndex(p => (p.id === bomData.productId || p.code === bomData.productId));
                if (mainProductIndex !== -1) {
                    mainProducts[mainProductIndex].hasBOM = true;
                    localStorage.setItem('productsData', JSON.stringify(mainProducts));
                }
                
                return newBOM;
            }
        }

        // Initialize BOM Manager
        const bomManager = new BOMManager();

        // Modal and form functions
        function showCreateBOMModal() {
            // Reload latest data
            bomManager.loadData();
            bomManager.renderProductOptions();
            
            document.getElementById('bomModalTitle').textContent = 'Tạo BOM mới';
            document.getElementById('bomForm').reset();
            bomManager.currentEditBOM = null;
            
            // Clear materials table
            document.getElementById('materialsTableBody').innerHTML = '';
            addMaterialRow(); // Add first row
            
            document.getElementById('bomModal').style.display = 'flex';
        }

        function closeBOMModal() {
            document.getElementById('bomModal').style.display = 'none';
            bomManager.currentEditBOM = null;
        }

        function addMaterialRow() {
            const tbody = document.getElementById('materialsTableBody');
            const row = document.createElement('tr');
            const rowId = Date.now();
            
            // Reload materials data to get latest
            bomManager.loadData();
            
            row.innerHTML = `
                <td>
                    <select class="form-select material-select" onchange="updateMaterialInfo(this)" required>
                        <option value="">Chọn NVL</option>
                        ${bomManager.materials.map(m => `<option value="${m.id || m.code}">${(m.code || m.id)} - ${m.name}</option>`).join('')}
                    </select>
                </td>
                <td><input type="text" class="form-input material-name" readonly></td>
                <td><input type="text" class="form-input material-unit" readonly></td>
                <td><input type="number" class="form-input material-quantity" min="0.01" step="0.01" required></td>
                <td><input type="text" class="form-input material-notes"></td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeMaterialRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        }

        function removeMaterialRow(button) {
            const row = button.closest('tr');
            row.remove();
        }

        function updateMaterialInfo(select) {
            const row = select.closest('tr');
            const materialId = select.value;
            const material = bomManager.materials.find(m => (m.id === materialId || m.code === materialId));
            
            if (material) {
                row.querySelector('.material-name').value = material.name;
                row.querySelector('.material-unit').value = material.unit || 'Cái';
            } else {
                row.querySelector('.material-name').value = '';
                row.querySelector('.material-unit').value = '';
            }
        }

        function loadProductInfo() {
            const productId = document.getElementById('bomProductSelect').value;
            if (productId) {
                // Reload data to get latest
                bomManager.loadData();
                
                const existingBOM = bomManager.boms.find(b => (b.productId === productId));
                if (existingBOM) {
                    if (confirm('Sản phẩm này đã có BOM. Bạn có muốn thay thế BOM hiện tại?')) {
                        // Load existing BOM data for editing
                        document.getElementById('bomDescription').value = existingBOM.description || '';
                        
                        // Clear and load materials
                        document.getElementById('materialsTableBody').innerHTML = '';
                        existingBOM.materials.forEach(material => {
                            addMaterialRow();
                            const lastRow = document.querySelector('#materialsTableBody tr:last-child');
                            lastRow.querySelector('.material-select').value = material.materialId;
                            updateMaterialInfo(lastRow.querySelector('.material-select'));
                            lastRow.querySelector('.material-quantity').value = material.quantity;
                            lastRow.querySelector('.material-notes').value = material.notes || '';
                        });
                        
                        bomManager.currentEditBOM = existingBOM;
                    } else {
                        document.getElementById('bomProductSelect').value = '';
                        return;
                    }
                }
            }
        }

        function saveBOM() {
            const form = document.getElementById('bomForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const productId = document.getElementById('bomProductSelect').value;
            const product = bomManager.products.find(p => (p.id === productId || p.code === productId));
            if (!product) {
                window.notifications.error('Vui lòng chọn sản phẩm');
                return;
            }

            // Get materials data
            const materialRows = document.querySelectorAll('#materialsTableBody tr');
            const materials = [];
            
            for (let row of materialRows) {
                const materialId = row.querySelector('.material-select').value;
                const quantity = parseFloat(row.querySelector('.material-quantity').value);
                const notes = row.querySelector('.material-notes').value;
                
                if (!materialId || !quantity) {
                    window.notifications.error('Vui lòng điền đầy đủ thông tin nguyên vật liệu');
                    return;
                }
                
                const material = bomManager.materials.find(m => (m.id === materialId || m.code === materialId));
                if (material) {
                    materials.push({
                        materialId: material.id || material.code,
                        materialName: material.name,
                        unit: material.unit || 'Cái',
                        quantity: quantity,
                        notes: notes
                    });
                }
            }

            if (materials.length === 0) {
                window.notifications.error('Vui lòng thêm ít nhất một nguyên vật liệu');
                return;
            }

            const bomData = {
                productId: product.id || product.code,
                productName: product.name,
                description: document.getElementById('bomDescription').value,
                materials: materials
            };

            try {
                bomManager.addBOM(bomData);
                bomManager.renderProductOptions();
                bomManager.updateStatistics();
                bomManager.loadBOMForProduct(product.id || product.code);
                
                const action = bomManager.currentEditBOM ? 'cập nhật' : 'tạo';
                window.notifications.success(`Đã ${action} BOM cho sản phẩm ${product.name}`);
                closeBOMModal();
                
                // Update product select
                document.getElementById('productSelect').value = product.id || product.code;
            } catch (error) {
                window.notifications.error('Có lỗi xảy ra khi lưu BOM');
                console.error('Error saving BOM:', error);
            }
        }

        // Event handlers
        document.getElementById('productSelect').addEventListener('change', function() {
            const productId = this.value;
            if (productId) {
                bomManager.loadBOMForProduct(productId);
            } else {
                document.getElementById('bomStructureCard').style.display = 'none';
                document.getElementById('bomDetailsCard').style.display = 'none';
            }
        });

        // Other functions
        function importBOM() {
            window.notifications.info('Nhập BOM từ Excel');
        }
        
        function exportBOM() {
            if (bomManager.currentSelectedProduct) {
                window.notifications.success('Đã xuất BOM');
            } else {
                window.notifications.warning('Vui lòng chọn BOM để xuất');
            }
        }
        
        function editCurrentBOM() {
            if (!bomManager.currentSelectedProduct) {
                window.notifications.warning('Vui lòng chọn BOM để chỉnh sửa');
                return;
            }
            
            // Open modal with current BOM data
            const bom = bomManager.boms.find(b => b.productId === bomManager.currentSelectedProduct);
            if (bom) {
                document.getElementById('bomModalTitle').textContent = 'Chỉnh sửa BOM';
                document.getElementById('bomProductSelect').value = bom.productId;
                document.getElementById('bomDescription').value = bom.description || '';
                
                // Clear and load materials
                document.getElementById('materialsTableBody').innerHTML = '';
                bom.materials.forEach(material => {
                    addMaterialRow();
                    const lastRow = document.querySelector('#materialsTableBody tr:last-child');
                    lastRow.querySelector('.material-select').value = material.materialId;
                    updateMaterialInfo(lastRow.querySelector('.material-select'));
                    lastRow.querySelector('.material-quantity').value = material.quantity;
                    lastRow.querySelector('.material-notes').value = material.notes || '';
                });
                
                bomManager.currentEditBOM = bom;
                document.getElementById('bomModal').style.display = 'flex';
            }
        }
        
        function viewMaterial(materialId) {
            window.location.href = `materials.html?id=${materialId}`;
        }
        
        function createPR(materialId) {
            window.notifications.info(`Tạo yêu cầu mua hàng cho ${materialId}`);
            window.location.href = `procurement.html?material=${materialId}`;
        }
        
        function calculateProduction() {
            const qty = document.getElementById('productionQty').value;
            window.notifications.info(`Tính toán cho ${qty} sản phẩm`);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('bomModal');
            if (event.target === modal) {
                closeBOMModal();
            }
        }

        // Custom styles
        const customStyles = `
            /* Filter Section */
            .filters-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 1rem;
                flex-wrap: wrap;
            }
            
            .search-group {
                display: flex;
                align-items: center;
                gap: 1rem;
                flex: 1;
            }
            
            .action-buttons {
                display: flex;
                gap: 0.5rem;
                flex-shrink: 0;
            }
            
            /* Card Headers */
            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid #f1f3f4;
            }
            
            .card-title {
                margin: 0;
                color: #333;
                font-size: 1.25rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .card-title i {
                color: #6366f1;
            }
            
            /* BOM Tree */
            .bom-tree {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                padding: 2rem;
                border-radius: 10px;
                border: 1px solid #e2e8f0;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            .tree-item {
                padding: 0.75rem 0;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                font-size: 1rem;
                border-radius: 8px;
                margin: 0.25rem 0;
                transition: background-color 0.2s;
            }
            
            .tree-item:hover {
                background: rgba(99, 102, 241, 0.05);
            }
            
            .tree-item i {
                font-size: 1.1rem;
            }
            
            .tree-item .fas.fa-box {
                color: #3b82f6;
            }
            
            .tree-item .fas.fa-cube {
                color: #10b981;
            }
            
            .tree-item .fas.fa-minus {
                color: #6b7280;
            }
            
            .badge {
                display: inline-block;
                font-size: 0.75rem;
                font-weight: 500;
                letter-spacing: 0.025em;
            }
            
            /* Production Calculation */
            .production-result {
                display: flex;
                align-items: baseline;
                gap: 0.5rem;
                background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
                padding: 1rem 1.5rem;
                border-radius: 10px;
                border: 1px solid #86efac;
            }
            
            .production-number {
                font-size: 2rem;
                font-weight: 700;
                color: #166534;
            }
            
            .production-unit {
                font-size: 1rem;
                color: #15803d;
                font-weight: 500;
            }
            
            .alert {
                padding: 1rem 1.25rem;
                border-radius: 8px;
                border: 1px solid;
                display: flex;
                align-items: flex-start;
                gap: 0.75rem;
            }
            
            .alert-warning {
                background: #fef3c7;
                border-color: #f59e0b;
                color: #92400e;
            }
            
            .alert-warning i {
                color: #f59e0b;
                margin-top: 0.125rem;
            }
            
            /* Table Container */
            .table-container {
                border-radius: 10px;
                overflow: hidden;
                border: 1px solid #e5e7eb;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            /* Buttons */
            .btn-sm { 
                padding: 0.375rem 0.75rem; 
                font-size: 0.875rem; 
                margin: 0 0.125rem; 
                border-radius: 6px;
                font-weight: 500;
            }
            
            .btn-group { 
                display: flex; 
                gap: 0.25rem; 
            }
            
            /* Modal Styles */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                backdrop-filter: blur(4px);
            }
            
            .modal-content {
                background: white;
                border-radius: 12px;
                width: 90%;
                max-width: 900px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            
            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1.5rem 2rem;
                border-bottom: 1px solid #e5e7eb;
                background: #f9fafb;
                border-radius: 12px 12px 0 0;
            }
            
            .modal-header h3 {
                margin: 0;
                color: #111827;
                font-size: 1.5rem;
                font-weight: 600;
            }
            
            .modal-close {
                background: none;
                border: none;
                font-size: 1.75rem;
                cursor: pointer;
                color: #6b7280;
                transition: color 0.2s;
                width: 2rem;
                height: 2rem;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 6px;
            }
            
            .modal-close:hover {
                color: #374151;
                background: #f3f4f6;
            }
            
            .modal-body {
                padding: 2rem;
            }
            
            .modal-footer {
                display: flex;
                justify-content: flex-end;
                gap: 0.75rem;
                padding: 1.5rem 2rem;
                border-top: 1px solid #e5e7eb;
                background: #f9fafb;
                border-radius: 0 0 12px 12px;
            }
            
            .materials-container {
                max-height: 400px;
                overflow-y: auto;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                margin-top: 0.5rem;
            }
            
            .materials-container .data-table {
                margin-bottom: 0;
            }
            
            .materials-container .data-table input,
            .materials-container .data-table select {
                border: none;
                padding: 0.75rem;
                font-size: 0.875rem;
                width: 100%;
            }
            
            .materials-container .data-table input:focus,
            .materials-container .data-table select:focus {
                outline: 2px solid #6366f1;
                outline-offset: -2px;
            }
            
            /* Responsive */
            @media (max-width: 768px) {
                .filters-row {
                    flex-direction: column;
                    align-items: stretch;
                }
                
                .action-buttons {
                    justify-content: center;
                    width: 100%;
                }
                
                .card-header {
                    flex-direction: column;
                    gap: 1rem;
                    align-items: flex-start;
                }
                
                .card-header .action-buttons {
                    width: 100%;
                    justify-content: flex-start;
                }
                
                .modal-content {
                    width: 95%;
                    margin: 1rem;
                }
                
                .production-result {
                    text-align: center;
                }
                
                .bom-tree {
                    padding: 1rem;
                }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = customStyles;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
